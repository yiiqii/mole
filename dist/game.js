var config={moleUpTime:100,moleDelayTime:350,moleHitOutTime:.5,ticker:{time:60,total:15},molePreSynNum:8,moleSynNum:[1,3],moles:[{name:"pd",score:20,prob:[8,10]},{name:"dc",score:30,prob:[5,6]},{name:"ty",score:100,prob:[1,3]},{name:"ali",score:50,prob:[1,3]}]},RESOURCES={s_btn_prize_png:"res/images/4s/btn_prize.png",s_btn_share_png:"res/images/4s/btn_share.png",s_bg_jpg:"res/images/bg.jpg",s_black_square_png:"res/images/black_square.png",s_btn_bottom_png:"res/images/btn_bottom.png",s_btn_pause_png:"res/images/btn_pause.png",s_btn_start_png:"res/images/btn_start.png",s_countdown_tile_json:"res/images/countdown_tile.json",s_countdown_tile_png:"res/images/countdown_tile.png",s_front_bottom_png:"res/images/front_bottom.png",s_hammer_png:"res/images/hammer.png",s_hole_png:"res/images/hole.png",s_loading_mole_png:"res/images/loading_mole.png",s_mole_tile_json:"res/images/mole_tile.json",s_mole_tile_png:"res/images/mole_tile.png"},MASK_DATA=[{x:22,y:148,s:.39},{x:102,y:148,s:.39},{x:180,y:148,s:.39},{x:0,y:221,s:.4625},{x:90,y:221,s:.4625},{x:178,y:221,s:.4625},{x:-13,y:305,s:.5},{x:84,y:305,s:.5},{x:180,y:305,s:.5}],MOLE_DATA=[{x:52,y:164,s:.4},{x:132,y:164,s:.4},{x:210,y:164,s:.4},{x:37,y:240,s:.4625},{x:127,y:240,s:.4625},{x:215,y:240,s:.4625},{x:27,y:326,s:.5},{x:124,y:326,s:.5},{x:220,y:326,s:.5}],GameData={getMaskData:function(){return MASK_DATA},getMoleData:function(t,e){switch(t.oy=55,e){case"ty":t.s*=1.12,t.x-=6,t.y-=10;break;case"pd":t.s*=1.1,t.x-=6,t.y-=6;break;case"dc":t.s*=1.05,t.x-=6,t.y-=3}return t}},Bottom=function(t){this._parent=t,Tiny.Container.call(this),Tiny.config._is4S?this.render4SSprite(this):this.renderSprite(this)};Bottom.prototype=Object.create(Tiny.Container.prototype),Bottom.prototype.constructor=Bottom,Bottom.prototype.renderSprite=function(t){var e=new Tiny.Sprite.fromImage(RESOURCES.s_btn_bottom_png),i=new Tiny.Sprite.fromImage(RESOURCES.s_front_bottom_png);e.setPositionX(Tiny.WIN_SIZE.width/2-e.width/2),e.setPositionY(Tiny.WIN_SIZE.height-e.height+10),i.setPositionY(Tiny.WIN_SIZE.height-i.height),this.addChild(e),this.addChild(i),i.setEventEnabled(!0),i.touchstart=i.mousedown=function(e){var i=e.data.global;i.x<window.innerWidth/2?(console.log("查看奖品"),t.viewPrizeHandler()):(console.log("分享"),t.shareHandler())}},Bottom.prototype.render4SSprite=function(t){var e=new Tiny.Sprite.fromImage(RESOURCES.s_btn_share_png),i=new Tiny.Sprite.fromImage(RESOURCES.s_btn_prize_png);e.setScale(2),i.setScale(2),e.setPositionX(Tiny.WIN_SIZE.width-e.width),e.setPositionY(70),i.setPositionY(70),this.addChild(e),this.addChild(i),e.setEventEnabled(!0),i.setEventEnabled(!0),e.touchstart=e.mousedown=function(e){t.shareHandler()},i.touchstart=i.mousedown=function(e){t.viewPrizeHandler()}},Bottom.prototype.shareHandler=function(){this._parent._start&&Tiny.isFunction(window.GAME_BRIDGE.shareHandler)&&window.GAME_BRIDGE.shareHandler()},Bottom.prototype.viewPrizeHandler=function(){this._parent._start&&Tiny.isFunction(window.GAME_BRIDGE.viewPrizeHandler)&&window.GAME_BRIDGE.viewPrizeHandler()};var Score=function(){this.scores={}};Score.prototype.constructor=Score,Score.prototype.update=function(t){this.scores[t.type]||(this.scores[t.type]={time:0,score:0}),this.scores[t.type].time++,this.scores[t.type].score+=Number(t.score),console.log(this.scores)},Score.prototype.getScores=function(){return this.scores};var Countdown=function(t){this._parent=t,this._prevNum=0,this._tickNum=0,this._speed=1e3*Tiny.settings.TARGET_FPMS/t._speed,Tiny.Container.call(this);var e=Tiny.Sprite.fromFrame("track.png");this.addChild(e);var i=Tiny.Sprite.fromFrame("bar.png");this.addChild(i);var n=new Tiny.Graphics;n.lineStyle(0),n.beginFill(16777215),n.moveTo(12,6),n.lineTo(490,6),n.lineTo(490,22),n.lineTo(12,22),n.quadraticCurveTo(2,16,12,6),n.endFill(),n.setPosition(0,0),this.addChild(n);var o=Tiny.Sprite.fromFrame("label.png");o.setPosition(-100,-6),this.addChild(o),this.setPosition(Tiny.WIN_SIZE.width/2-this.width/2+100,840-this.height/2),(Tiny.config._isiPad||Tiny.config._is4S)&&(this.setPosition(Tiny.WIN_SIZE.width/2-.75*this.width/2+88,330-this.height/2),this.setScale(.75)),i.mask=n,this._masker=n};Countdown.prototype=Object.create(Tiny.Container.prototype),Countdown.prototype.constructor=Countdown,Countdown.prototype.update=function(t){var e=config.ticker.total;t!=this._prevNum?(this._prevNum=t,this._tickNum=t,this._speed=1e3*Tiny.settings.TARGET_FPMS/this._parent._speed):this._tickNum+=1/this._speed;var i=(e-this._tickNum)/e;this._masker.setPositionX(460*(1-i.toFixed(4)))};var Guide=function(t){this._parent=t,Tiny.Container.call(this);var e=Tiny.Sprite.fromImage(RESOURCES.s_black_square_png);e.setScale(143/7,52/7),e.setPosition(120,20),e.setOpacity(0),this.addChild(e),this.setEventEnabled(!0),this.touchstart=this.mousedown=function(t){this._parent._start&&Tiny.isFunction(window.GAME_BRIDGE.guideHandler)&&window.GAME_BRIDGE.guideHandler()}};Guide.prototype=Object.create(Tiny.Container.prototype),Guide.prototype.constructor=Guide;var Launcher=function(t){Tiny.Container.call(this);var e=Tiny.Sprite.fromImage(RESOURCES.s_black_square_png);e.setScale(Tiny.WIN_SIZE.width/7,Tiny.WIN_SIZE.height/7),this.addChild(e);var i=Tiny.Sprite.fromImage(RESOURCES.s_btn_start_png);i.setPosition(Tiny.WIN_SIZE.width/2,Tiny.WIN_SIZE.height/2),i.setAnchor(.5),i.setOpacity(0),this.addChild(i);var n=this,o=Tiny.FadeTo(300,.8);o.onComplete=function(){n.setEventEnabled(!0)},e.runAction(o);var r=Tiny.FadeIn(300);i.runAction(r);var s=Tiny.FadeOut(300);s.onComplete=function(){t.run(),t.removeChild(n),Tiny.isFunction(window.GAME_BRIDGE.gameStart)&&window.GAME_BRIDGE.gameStart()},this.touchstart=this.mousedown=function(t){n._clicked||(n._clicked=!0,n.runAction(s))}};Launcher.prototype=Object.create(Tiny.Container.prototype),Launcher.prototype.constructor=Launcher;var Pause=function(t){Tiny.Container.call(this);var e=Tiny.Sprite.fromImage(RESOURCES.s_black_square_png);e.setScale(Tiny.WIN_SIZE.width/7,Tiny.WIN_SIZE.height/7),this.addChild(e);var i=Tiny.Sprite.fromImage(RESOURCES.s_btn_pause_png);i.setPosition(Tiny.WIN_SIZE.width/2,Tiny.WIN_SIZE.height/2),i.setAnchor(.5),i.setOpacity(1),this.addChild(i);var n=this,o=Tiny.FadeTo(300,.8);o.onComplete=function(){n.setEventEnabled(!0)},e.runAction(o),this.touchstart=this.mousedown=function(e){n._clicked||(n._clicked=!0,t._start=!0,n.hide(),Tiny.isFunction(window.GAME_BRIDGE.gameResume)&&window.GAME_BRIDGE.gameResume())},this.hide()};Pause.prototype=Object.create(Tiny.Container.prototype),Pause.prototype.constructor=Pause,Pause.prototype.hide=function(){this.setPositionX(Tiny.WIN_SIZE.width),this._clicked=!1},Pause.prototype.show=function(){this.setPositionX(0)};var BackgroundScene=function(){};BackgroundScene.prototype.init=function(){var t=Tiny.Texture.fromImage(RESOURCES.s_bg_jpg),e=new Tiny.Sprite(t);return e.width=Tiny.WIN_SIZE.width,e.height=1138,e},BackgroundScene.create=function(){var t=new BackgroundScene;return t.init()};var HoleScene=function(){};HoleScene.prototype.init=function(){var t=Tiny.Texture.fromImage(RESOURCES.s_hole_png),e=new Tiny.Sprite(t);return e.width=Tiny.WIN_SIZE.width,e.height=478,e.setPositionY(368),e},HoleScene.create=function(){var t=new HoleScene;return t.init()};var Mask=function(t,e){var i=new Tiny.Graphics;return i.lineStyle(0),i.beginFill(16711680),i.moveTo(0,63),i.lineTo(64,130),i.lineTo(80,166),i.lineTo(132,180),i.lineTo(164,158),i.lineTo(184,180),i.lineTo(180,168),i.lineTo(230,158),i.lineTo(222,138),i.lineTo(266,50),i.quadraticCurveTo(133,-50,0,63),i.endFill(),i.setScale(2*e),i.setPosition(2*t.x,2*t.y),i.setOpacity(0),i},MaskScene=function(){Tiny.Container.call(this);var t=this;GameData.getMaskData().forEach(function(e){t.addChild(new Mask(Tiny.point(e.x,e.y),e.s))})};MaskScene.prototype=Object.create(Tiny.Container.prototype),MaskScene.prototype.constructor=MaskScene;var Mole=function(t,e,i){this._parent=i,this._type=t,this._index=e,this._hit=!1,this.hitTime=0;var n=Tiny.Texture.fromFrame(t+"_mole.png");Tiny.Sprite.call(this,n),console.log("地鼠出现的位置:",e);var o=MOLE_DATA[e];o=GameData.getMoleData(o,t),this.oy=2*o.oy,this.scale=Tiny.point(2*o.s),this.setPosition(2*o.x,2*(o.y+o.oy)),this.mask=i._masks.getChildAt(e)};Mole.prototype=Object.create(Tiny.Sprite.prototype),Mole.prototype.constructor=Mole,Mole.prototype.up=function(t){var e=Tiny.MoveTo(config.moleUpTime,Tiny.point(this.x,this.y-this.oy));e.onComplete=function(){t&&t()},this.runAction(e)},Mole.prototype.down=function(t){var e=Tiny.MoveTo(config.moleUpTime,Tiny.point(this.x,this.y+this.oy));e.setName("down");var i=this;e.setDelay(config.moleDelayTime),e.onComplete=function(){i._parent._moleCell.removeChild(i),t&&t()},this.runAction(e)},Mole.prototype.hit=function(){this._hit||(console.log(this._type+this._index+"被打中了"),this._hit=!0,this.hitTime=Tiny.getTime(),this.actions.forEach(function(t){"down"==t.name&&t.stop()}),this.texture=Tiny.Texture.fromFrame(this._type+"_mole_hit.png"))},Mole.prototype.getScore=function(){var t={},e=this;return config.moles.forEach(function(i){i.name==e._type&&(t={type:[e._type],score:i.score})}),t};var Hammber=function(t){this._parent=t,Tiny.Sprite.call(this,Tiny.Texture.fromImage(RESOURCES.s_hammer_png)),this.anchor=Tiny.point(0,1),this.setAnchor(1)};Hammber.prototype=Object.create(Tiny.Sprite.prototype),Hammber.prototype.constructor=Hammber,Hammber.prototype.updatePos=function(t){var e=window.innerWidth/Tiny.WIN_SIZE.width,i=this._parent._hole,n=i.getPositionY()*e,o=i.height*e+n;t.y<n-20||t.y>o+20||(this.setPosition(t.x/e+this.width/2+20||0,t.y/e+this.height/2-40||0),this.beat())},Hammber.prototype.beat=function(){var t=this,e=Tiny.RotateTo(100,{rotation:Tiny.deg2radian(-30)}),i=Tiny.FadeOut(300);i.setDelay(500),e.onComplete=function(){t.runAction(i)},Tiny.Action.cleanup(this),this.setRotation(0),this.setOpacity(1),this.runAction(Tiny.Back(e))};var StartLayer=function(){this.moleProb=[],this._speed=1,this._currentTime=0,this._time=config.ticker.time,this._prePos=[],this._start=!1,this._timeOut=!1,this._count=0,this._background=BackgroundScene.create(),this._guide=new Guide(this),this._hole=HoleScene.create(),this._hammer=new Hammber(this),this._masks=new MaskScene,this._moleCell=new Tiny.Container,this._score=new Score,this._countdown=new Countdown(this),this._bottom=new Bottom(this),this._launcher=new Launcher(this),this._pauser=new Pause(this),Tiny.Container.call(this),this.init(),this.interactive=!0,this.touchstart=this.mousedown=function(t){var e=t.target,i=t.data.global;e._start&&(e._hammer.updatePos(i),e._moleCell.children.forEach(function(t){var n=t.getBounds();n.height-=20;var o=Tiny.rectContainsPoint(n,i);o&&(t.hit(),e._score.update(t.getScore()))}))};var t=this;window.GAME_BRIDGE.gamePause=function(){t._start&&t.pause()}};StartLayer.prototype=Object.create(Tiny.Container.prototype),StartLayer.prototype.constructor=StartLayer,StartLayer.prototype.init=function(){this.addChild(this._background),this.addChild(this._hole),this.addChild(this._moleCell),this.addChild(this._masks),this.addChild(this._countdown),this.addChild(this._bottom),this.addChild(this._guide),this.addChild(this._hammer),this.addChild(this._launcher),this.addChild(this._pauser),this.reset();for(var t=this.generateMoleList(),e=0;e<config.molePreSynNum;e++){var i=Tiny.randomFromArray(t);Tiny.arrayRemoveObject(t,i),this.createMole(i,!0)}Tiny.isFunction(window.GAME_BRIDGE.gameInit)&&window.GAME_BRIDGE.gameInit()},StartLayer.prototype.run=function(){var t=this;t.reset(),this._moleCell.children.forEach(function(e,i){e.down(function(){0==i&&(t._start=!0)})})},StartLayer.prototype.reset=function(){this._prePos=[],this._start=!1,this._currentTime=0,this._count=0,this.moleProbInit()},StartLayer.prototype.updateTransform=function(){this._start&&((this.moleProb.length<3||this._count>config.ticker.total)&&(this._timeOut=!0),this._speed=1*this.getRealSpeed(),this._timeOut?this.gameOver():(this.tick(),this._countdown.update(this._count-1))),this._timeOut&&!this._start||(this._moleCell.children.forEach(function(t){t.hitTime&&Tiny.getTime()-t.hitTime>1e3*config.moleHitOutTime&&(t.hitTime=0,t.actions.forEach(function(t){"down"==t.name&&t.start()}))}),this.containerUpdateTransform())},StartLayer.prototype.getRealSpeed=function(){return(1e3*Tiny.settings.TARGET_FPMS/(10*Math.ceil(Tiny.ticker.shared.FPS/10)||60)).toFixed(0)},StartLayer.prototype.tick=function(){this._currentTime+=Number(this._speed);var t=this._currentTime+.5|0;if(this._currentTime=this._currentTime%this._time,t>=this._time){for(var e=this.generateMoleList(),i=[],n=0;n<Tiny.randomFromArray(config.moleSynNum);n++){var o=Tiny.randomFromArray(e);Tiny.arrayRemoveObject(e,o),i.push(o),this.createMole(o)}this._prePos=i,this._count++}},StartLayer.prototype.createMole=function(t,e){var i=this._moleCell,n=Tiny.random(0,this.moleProb.length-1),o=this.moleProb.splice(n,1),r=new Mole(o,t,this);i.addChild(r),r.up(function(){e||r.down()})},StartLayer.prototype.moleProbInit=function(){var t=this;t.moleProb=[],config.moles.forEach(function(e){for(var i=0;i<Tiny.randomFromArray(e.prob)*config.moleSynNum[config.moleSynNum.length-1];i++)t.moleProb.push(e.name)}),console.log("地鼠出现概率:",t.moleProb)},StartLayer.prototype.generateMoleList=function(){for(var t=[],e=0;e<MOLE_DATA.length;e++)t.push(e);for(var i=0;i<this._prePos.length;i++)Tiny.arrayRemoveObject(t,this._prePos[i]);return t},StartLayer.prototype.pause=function(){console.log("游戏暂停"),this._start=!1,this._pauser.show()},StartLayer.prototype.gameOver=function(){this._start=!1,console.log("游戏结束"),Tiny.isFunction(window.GAME_BRIDGE.gameOver)&&window.GAME_BRIDGE.gameOver(this._score.getScores())},function(){function t(){document.addEventListener("pause",function(t){Tiny.app.pause(),window.GAME_BRIDGE&&window.GAME_BRIDGE.gamePause()},!1),document.addEventListener("resume",function(t){Tiny.app.resume()},!1)}window.VIEW_HEIGHT=320*document.documentElement.clientHeight/document.documentElement.clientWidth;var e={showFPS:!0,dpi:2,canvasId:"TinyCanvas",renderOptions:{backgroundColor:8047077}};navigator.userAgent.toLowerCase().indexOf("mobile")>-1&&(e._is4S=window.VIEW_HEIGHT<=480,e._isiPad=window.VIEW_HEIGHT<=400),Tiny.app=new Tiny.Application(e);var i={init:function(){console.log("init"),this.resourceLoad()},resourceLoad:function(){var t=[];for(var e in RESOURCES)t.push(RESOURCES[e]);var i=document.getElementById("progress"),n=document.getElementById("percent"),o=document.getElementById("hole");Tiny.Loader.run({resources:t,onProgress:function(t){console.log("percent:",t+"%");var e=~~t;n.innerHTML=e+"%",i.style.marginTop=100-e+"%"},onAllComplete:function(){console.log("all complete");var t=document.body;t.removeChild(o),t.removeChild(n),t.removeChild(i.parentNode),Tiny.app.run(new StartLayer)}})}};i.init(),window.AlipayJSBridge?t():document.addEventListener("AlipayJSBridgeReady",function(){t()})}();